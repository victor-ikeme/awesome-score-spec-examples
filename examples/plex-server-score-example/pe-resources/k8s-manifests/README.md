Excellent question. Adapting the Plex workload for Kubernetes is a perfect exercise in platform engineering. It forces us to confront the fact that `network_mode: host` is a Docker-specific concept and requires a different, Kubernetes-native solution to achieve a similar outcome.

The developer's `score.yaml` will remain **almost identical**. The platform engineer's role is to provide the correct Kubernetes tooling to handle the special networking and volume requirements.

### The Kubernetes Challenge: `hostNetwork` and Host Paths

*   **Networking:** The direct equivalent of Docker's `network_mode: host` in Kubernetes is `hostNetwork: true` in the Pod specification. This is a highly privileged setting that allows the pod to use the node's network interface directly.
*   **Volumes:** Mounting a host directory (like `/media`) into a pod is done using a `hostPath` volume. This is also a privileged operation, as it gives the pod access to the underlying node's filesystem.

Because both of these are privileged, security-sensitive settings, the canonical Score approach is to use a **patch template** to apply them.

---

### The Universal Score Project for Plex

Here is the complete project, including the Kubernetes-specific tooling.

#### 1. `score.yaml` (Remains Unchanged)

The developer's definition of the workload does not need to change. It remains a clean, abstract definition of a Plex server that needs a media library.

```yaml
# score.yaml
apiVersion: score.dev/v1b1
metadata:
  name: plex-media-server
  annotations:
    awesome-score-spec.dev/description: "A Plex media server workload."
containers:
  plex:
    image: linuxserver/plex
    variables:
      VERSION: docker
    volumes:
      /media:
        source: ${resources.media-library}
resources:
  media-library:
    type: volume
    params:
      source: ${resources.env.PLEX_MEDIA_PATH}
  env:
    type: environment
```

---

### Platform Tooling for Kubernetes

#### 2. `k8s-plex-privileged.patch.tpl` (The Kubernetes Patch)

This is the platform engineer's tool for Kubernetes. It finds the Plex `Deployment` and injects the `hostNetwork: true` setting and the `hostPath` volume definition.

```go-template
# k8s-plex-privileged.patch.tpl
{{- range $name, $spec := .Workloads }}
  {{- /* We only want to patch the 'plex-media-server' workload */}}
  {{- if eq $name "plex-media-server" }}

# Set hostNetwork to true for the Pod
- op: set
  path: resources.deployment-{{ $name }}.spec.template.spec.hostNetwork
  value: true

# Add the hostPath volume definition for the media library
- op: add
  path: resources.deployment-{{ $name }}.spec.template.spec.volumes.-1
  value:
    name: media-library-volume
    hostPath:
      # This path comes from the node's filesystem, not the user's machine.
      path: "${PLEX_MEDIA_PATH}"
      type: DirectoryOrCreate

# Update the container's volumeMount to use the new hostPath volume
{{- range $cname, $c := $spec.containers }}
- op: set
  path: resources.deployment-{{ $name }}.spec.template.spec.containers.{{ $cname }}.volumeMounts
  value:
    - name: media-library-volume
      mountPath: /media
{{- end }}
  {{- end }}
{{- end }}
```

#### 3. `README.md` (Updated for Kubernetes Deployment)

```markdown
# Plex Media Server with Score (for Kubernetes)

This project demonstrates how to deploy a Plex media server, a workload with special networking and storage requirements, to Kubernetes using a single, portable `score.yaml` file.

## Kubernetes Architecture

To run Plex on Kubernetes, we must provide the equivalent of Docker's `network_mode: host` and a host directory mount.

*   **`hostNetwork: true`**: This is the Kubernetes equivalent of `network_mode: host`. It allows the Plex pod to directly use the network of the Kubernetes node it's scheduled on. This is necessary for network discovery features like DLNA.
*   **`hostPath` Volume**: To provide access to your media files, we use a `hostPath` volume. This mounts a directory from the Kubernetes node's own filesystem directly into the pod.
*   **Platform Patching**: Both `hostNetwork` and `hostPath` are privileged, platform-specific settings. We use a **patch template** (`k8s-plex-privileged.patch.tpl`) to apply these settings to the manifests generated by `score-k8s`. This maintains a clean separation between the developer's workload definition and the platform's implementation.

## How to Run with `score-k8s`

**Important Pre-setup:** This deployment assumes your media files are physically present on the Kubernetes node(s) where the Plex pod might be scheduled. For a single-node cluster like Minikube or Kind, you can place your media in a known directory (e.g., `/mnt/media`).

### Step 1: Prepare your Kubernetes Node
Ensure your media files are accessible on the node. For Minikube, you can use `minikube mount`:```bash
# In a separate terminal
minikube mount ./my-media-library:/mnt/media
```
This makes your local `my-media-library` directory available inside the Minikube VM at `/mnt/media`.

### Step 2: Create a `.env` file
This file will tell the patch template where to find the media directory *inside the node*.
```bash
# Create the .env file
cp .env.example .env
# Edit .env and set PLEX_MEDIA_PATH=/mnt/media (the path inside the node)
```

### Step 3: Initialize the Score Project
Register the Kubernetes-specific patch template with the project.
```bash
score-k8s init --patch-templates ./k8s-plex-privileged.patch.tpl
```

### Step 4: Generate the Kubernetes Manifests
```bash
score-k8s generate score.yaml --env-file .env -o manifests.yaml
```
*The `--env-file` flag is crucial here, as it allows the patch template to substitute `${PLEX_MEDIA_PATH}` with the correct path.*

### Step 5: Deploy the Application
```bash
kubectl apply -f manifests.yaml
```

### Step 6: Access the Application
Because the pod is using `hostNetwork`, you can access the Plex UI by navigating to your Kubernetes **node's IP address** at port `32400`. For Minikube, you can get the IP with `minikube ip`.
```bash
# Example
http://$(minikube ip):32400/web```
```

#### 4. `.env.example` (Updated for Kubernetes context)

```
# .env.example

# Set this to the absolute path of your media library ON THE KUBERNETES NODE.
# For Minikube with 'minikube mount', this would be the mount point (e.g., /mnt/media).
# For a bare-metal cluster, this would be a path like /data/plex-media.
PLEX_MEDIA_PATH=
```